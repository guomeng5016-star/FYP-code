---
title: "fypä»£ç 1"
output: html_document
date: "2025-10-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

elbowå›¾ç¡®å®šåˆ†ç±»
```{r}
A0<-read.csv("edgeR_CPM_Normalized_Counts_CD49f_CD133.csv",header = T)
#clean_data <- mydata[complete.cases(A), ]

#library(readxl)
#library(dplyr)
#library(openxlsx)
# Read the Excel files
#file1 <- read_excel("file1.xlsx")

A<-na.omit(A0)
A<-A[,-1:-4]
A<-as.matrix(A)
I<-A=="0"
# Compute k-means clustering for different values of k
wcss <- numeric(15)  #within-cluster sum of squares
for (i in 1:10) {
  kmeans_result <- kmeans(A, centers=i)
  wcss[i] <- kmeans_result$tot.withinss
}
# Plot the elbow curve
plot(1:15, wcss, type='b', pch=19, frame=FALSE, 
     xlab='Number of clusters', ylab='WCSS', main='Elbow Method')
# Add a line at the "elbow" point
#segments(x0=11, y0=min(wcss), x1=11, y1=max(wcss), lty=2, col='red')

```






```{r}
library(Rtsne)
library(ggplot2)
library(RColorBrewer)

# 1. è¯»å–æ•°æ®
A0 <- read.csv("edgeR_CPM_Normalized_Counts_CD49f_CD133.csv", header = TRUE)

# 2. æ•°æ®æ¸…æ´—ï¼ˆå»æ‰NAï¼‰
data_clean <- na.omit(A0)

# 3. å»æ‰ç¬¬ä¸€åˆ—ï¼ˆæ¯”å¦‚åŸºå› åï¼‰
data_expr <- data_clean[, -1]

# 4. é€‰å–å‰2000ä¸ªæ ·æœ¬ï¼ˆå¦‚æœä¸è¶³2000å°±å…¨é€‰ï¼‰
n <- min(2000, nrow(data_expr))
data_expr_subset <- data_expr[1:n, ]

# 5. è½¬ä¸ºçŸ©é˜µ
A <- as.matrix(data_expr_subset)

# 6. å»æ‰é‡å¤è¡Œï¼ˆt-SNE ä¸å…è®¸æœ‰é‡å¤æ ·æœ¬ï¼‰
A_unique <- unique(A)
dim(A_unique)
set.seed(42)
perplexity <- 50
library(Rtsne)
tsne_result <- Rtsne(A_unique, perplexity = perplexity)
a <- tsne_result$Y
set.seed(42)  # ä¿è¯ K-means ç»“æœå¯é‡å¤
custom_colors <- rainbow(5)
km <- kmeans(A_unique, centers = 5)
kc <- km$cluster
tsne_df <- as.data.frame(a)
tsne_df$cluster <- factor(kc)
X1 <- a[,1]
X2 <- a[,2]
library(ggplot2)
ggplot(tsne_df, aes(X1, X2, color = cluster)) +
  geom_point() +
  scale_color_manual(values = custom_colors) +
  ggtitle("t-sne plot for 50 genes with perplexity=50")

```


```{r}
# ç¨³å®šçš„å¤š perplexity t-SNE + K-means å¯è§†åŒ–
library(Rtsne)
library(ggplot2)
library(RColorBrewer)
library(gridExtra)

# 7. K-means èšç±»ï¼ˆé«˜ç»´ï¼‰
set.seed(42)
k <- 5  # èšç±»æ•°é‡
km <- kmeans(A_unique, centers = k)
kc <- km$cluster

# 8. å®šä¹‰é¢œè‰²
custom_colors <- brewer.pal(k, "Set1")

# 9. å¤š perplexity t-SNE
perplexities <- c(10, 20, 30, 40)
tsne_results <- list()
plots <- list()

for (p in perplexities) {
  set.seed(42)  # ä¿è¯æ¯æ¬¡ t-SNE å¯é‡å¤
  tsne_results[[as.character(p)]] <- Rtsne(A_unique, 
                                           perplexity = p, 
                                           pca = TRUE,  # PCA åˆå§‹åŒ–
                                           verbose = FALSE,
                                           check_duplicates = FALSE)
  
  # 10. æ•´ç† t-SNE ç»“æœ
  tsne_mat <- tsne_results[[as.character(p)]]$Y
  tsne_df <- data.frame(
    X1 = tsne_mat[,1],
    X2 = tsne_mat[,2],
    cluster = factor(kc)
  )
  
  # 11. ggplot ç»˜å›¾
  plots[[as.character(p)]] <- ggplot(tsne_df, aes(X1, X2, color = cluster)) +
    geom_point(size = 2, alpha = 0.8) +
    scale_color_manual(values = custom_colors) +
    ggtitle(paste("t-SNE, perplexity =", p)) +
    theme_minimal() +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank())
}

# 12. 2x2 ç½‘æ ¼å±•ç¤º
grid.arrange(grobs = plots, nrow = 2, ncol = 2)


# ======================================================
# 13. å¯¼å‡ºæ¯ä¸ª perplexity Ã— cluster çš„æ ·æœ¬åˆ—è¡¨
#    ï¼ˆæ–‡ä»¶åç¤ºä¾‹ï¼šperplexity_40_cluster_3_samples.csvï¼‰
# ======================================================

# ======================================================
# 13. å¯¼å‡ºæ¯ä¸ª perplexity Ã— cluster çš„â€œå®Œæ•´æ•°å€¼è¡¨â€
#    æ¯ä¸ªæ–‡ä»¶ = è¯¥ç°‡å¯¹åº”çš„æ ·æœ¬ + å…¨éƒ¨ç‰¹å¾åˆ—
#    æ–‡ä»¶åç¤ºä¾‹ï¼šperplexity_40_cluster_3_data.csv
# ======================================================

# ä¸ A_unique è¡Œé¡ºåºä¸€ä¸€å¯¹åº”çš„æ ·æœ¬åï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„å†™æ³•ï¼‰
sample_names <- data_clean[1:nrow(A_unique), 1]

for (p in perplexities) {
  tsne_mat <- tsne_results[[as.character(p)]]$Y

  # åœ¨è¯¥ perplexity çš„ t-SNE ç©ºé—´ä¸Šèšç±»
  set.seed(42)
  km_p <- kmeans(tsne_mat, centers = k)

  # æŒ‰ç°‡åˆ†åˆ«å¯¼å‡ºâ€œæ ·æœ¬å + æ•°å€¼çŸ©é˜µâ€
  for (i in 1:k) {
    idx <- which(km_p$cluster == i)
    if (length(idx) == 0) next

    # æ‹¼æ¥æˆå¸¦æ ·æœ¬åçš„ä¸€æ•´å¼ è¡¨
    df_i <- data.frame(
      Sample = sample_names[idx],
      A_unique[idx, , drop = FALSE],
      check.names = FALSE
    )

    # å¯¼å‡º
    write.csv(
      df_i,
      sprintf("perplexity_%s_cluster_%s_data.csv", p, i),
      row.names = FALSE
    )
  }
}
```

```{r}
# ====== æ£€éªŒåˆ†ç±»æ•ˆæœï¼šWilks' Î› + PCAæŠ•å½±Fæ£€éªŒï¼ˆä¸€é”®ç‰ˆï¼‰ ======
suppressPackageStartupMessages({
  library(readxl)
  library(dplyr)
  library(tools)
})

# è¯»å–ä¸€ä¸ªç°‡æ–‡ä»¶ï¼ˆCSVæˆ–XLSXï¼‰ï¼Œå¹¶è¿”å›ï¼šlist(data=çº¯æ•°å€¼çŸ©é˜µ, ids=æ ·æœ¬åå‘é‡, cols=ç‰¹å¾åˆ—å)
.read_cluster_file <- function(path) {
  ext <- tolower(file_ext(path))
  if (ext %in% c("csv", "txt")) {
    df <- read.csv(path, check.names = FALSE)
  } else if (ext %in% c("xlsx", "xls")) {
    df <- readxl::read_excel(path) %>% as.data.frame(check.names = FALSE)
  } else {
    stop("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ", path)
  }
  if ("Sample" %in% names(df)) {
    ids <- df$Sample
    df <- df[, setdiff(names(df), "Sample"), drop = FALSE]
  } else {
    ids <- seq_len(nrow(df))
  }
  # ä»…ä¿ç•™æ•°å€¼åˆ—
  num_cols <- names(df)[sapply(df, is.numeric)]
  df <- df[, num_cols, drop = FALSE]
  X <- as.matrix(df)
  storage.mode(X) <- "double"
  list(data = X, ids = ids, cols = colnames(X))
}

# ç»™å®šä¸€ä¸ª perplexity P ä¸ç°‡æ•° kï¼Œè‡ªåŠ¨è¯»å– "perplexity_P_cluster_i_data.*"
# å¹¶åšè®ºæ–‡ä¸­çš„ Wilks + æŠ•å½±F æ£€éªŒ
run_cluster_tests <- function(perplexity, k, dir = ".",
                              ridge = 1e-8,  # ç”¨äºdetç¨³å®šï¼ˆå¿…è¦æ—¶å¯¹SSW/SSTåŠ Î»Iï¼‰
                              verbose = TRUE) {

  # 1) è¯»å…¥æ‰€æœ‰ç°‡
  files_found <- c()
  mats <- list()
  ns <- integer(k)
  for (i in 1:k) {
    # ä¼˜å…ˆCSVï¼Œå†XLSX
    cand_csv  <- file.path(dir, sprintf("perplexity_%s_cluster_%s_data.csv",  perplexity, i))
    cand_xlsx <- file.path(dir, sprintf("perplexity_%s_cluster_%s_data.xlsx", perplexity, i))
    path <- if (file.exists(cand_csv)) cand_csv else if (file.exists(cand_xlsx)) cand_xlsx else NA
    if (is.na(path)) stop("æœªæ‰¾åˆ°æ–‡ä»¶ï¼š", cand_csv, " æˆ– ", cand_xlsx)

    cf <- .read_cluster_file(path)
    files_found[i] <- path
    mats[[i]] <- cf
    ns[i] <- nrow(cf$data)
  }
  if (verbose) message("è¯»å–åˆ°æ–‡ä»¶ï¼š\n", paste(files_found, collapse = "\n"))

  # 2) å¯¹é½åˆ—ï¼šä½¿ç”¨æ‰€æœ‰ç°‡å…±åŒçš„ç‰¹å¾åˆ—ï¼Œå¹¶æŒ‰ç›¸åŒé¡ºåºæ’åˆ—
  common_cols <- Reduce(intersect, lapply(mats, function(x) x$cols))
  if (length(common_cols) == 0) stop("å„ç°‡ä¹‹é—´æ²¡æœ‰å…±åŒçš„æ•°å€¼åˆ—ï¼Œè¯·æ£€æŸ¥æ•°æ®ã€‚")
  mats <- lapply(mats, function(x) {
    X <- x$data[, common_cols, drop = FALSE]
    x$data <- X
    x$cols <- common_cols
    x
  })

  # 3) çºµå‘æ‹¼æ¥æˆ Xï¼›è®°å½•æ€» nã€pã€k
  A_list <- lapply(mats, function(x) x$data)
  X <- do.call(rbind, A_list)              # n Ã— p
  n_vec <- ns
  n <- sum(n_vec)
  p <- ncol(X); k <- length(A_list)

  if (n <= 2 || p < 1) stop("æ ·æœ¬é‡æˆ–ç»´åº¦ä¸åˆç†ã€‚n=", n, ", p=", p)
  if (verbose) message(sprintf("n=%d, p=%d, k=%d", n, p, k))

  # ========== Wilks' Î›ï¼ˆè¿‘ä¼¼å¡æ–¹ï¼‰ ==========
  # ç»„å†…ç¦»å·®çŸ©é˜µ SSW å’Œ æ€»ç¦»å·®çŸ©é˜µ SST
  # SSW = sum (X_i^T (I - 1/n_i J) X_i)
  make_center_mat <- function(m) diag(m) - (1/m) * matrix(1, m, m)
  SSW <- matrix(0, p, p)
  start <- 1
  for (i in seq_len(k)) {
    ni <- n_vec[i]
    idx <- start:(start + ni - 1)
    Xi <- X[idx, , drop = FALSE]
    SSW <- SSW + t(Xi) %*% make_center_mat(ni) %*% Xi
    start <- start + ni
  }
  SST <- t(X) %*% make_center_mat(n) %*% X

  # æ•°å€¼ç¨³å®šï¼šå¦‚SSTæˆ–SSWæ¥è¿‘å¥‡å¼‚ï¼ŒåŠ å…¥æå°ridge
  SSW_r <- SSW + ridge * diag(p)
  SST_r <- SST + ridge * diag(p)

  # log(det(SSW)/det(SST))ï¼›ä½¿ç”¨ determinant() æ›´ç¨³å¥
  det_SSW <- determinant(SSW_r, logarithm = TRUE)$modulus
  det_SST <- determinant(SST_r, logarithm = TRUE)$modulus
  Ls <- as.numeric(det_SSW - det_SST)  # log ratio
  F5 <- -(n - 1 - (p + k)/2) * Ls
  pv5 <- pchisq(F5, df = p * (k - 1), lower.tail = FALSE)

  # ========== PCAæŠ•å½±çš„ç²¾ç¡®Fæ£€éªŒï¼ˆLÃ¤uteræ€è·¯ï¼‰ ==========
  # æ„é€  n Ã— (n-1) çš„HelmertçŸ©é˜µ aï¼ˆä¸ä½ ç»™çš„å‚è€ƒä»£ç ä¸€è‡´ï¼‰
  a <- matrix(0, nrow = n, ncol = n - 1)
  for (j in 1:(n - 1)) {
    a[j + 1, j] <- -j / sqrt((j + 1) * j)
    for (l in 1:j) a[l, j] <- 1 / sqrt((j + 1) * j)
  }

  Y <- t(a) %*% X                 # (n-1) Ã— p
  W <- t(Y) %*% Y / (n - 1)       # p Ã— p
  E <- eigen(t(W) %*% W)          # p Ã— p
  D <- E$vectors

  r_max <- min(n - 1, p) - 1
  if (r_max < 1) stop("r_max < 1ï¼Œæ ·æœ¬é‡æˆ–ç»´åº¦ä¸è¶³ä»¥è¿›è¡ŒæŠ•å½±Fæ£€éªŒã€‚")

  r1 <- max(1, floor(r_max / 4))
  r2 <- max(1, floor(r_max / 3))
  r3 <- max(1, floor(r_max / 2))
  r4 <- max(1, floor(3 * r_max / 4))

  f_stat <- c(); p_val <- c(); labels <- c()

  compute_F <- function(r) {
    V <- Y %*% D[, 1:r, drop = FALSE]    # (n-1) Ã— r
    J <- matrix(1, nrow = n - 1, ncol = n - 1)
    H <- t(V) %*% J %*% V / (n - 1)      # r Ã— rï¼ˆæœªç›´æ¥ä½¿ç”¨ï¼Œä¿ç•™ç»“æ„ï¼‰
    G <- t(V) %*% (diag(n - 1) - J / (n - 1)) %*% V  # r Ã— r
    u <- matrix(1, nrow = n - 1, ncol = 1)
    Fv <- (n - 1 - r) / ((n - 1) * r) * t(u) %*% V %*% solve(G) %*% t(V) %*% u
    Fv <- as.numeric(Fv)
    pv <- pf(Fv, df1 = r, df2 = (n - 1 - r), lower.tail = FALSE)
    c(Fv, pv)
  }

  c1 <- compute_F(r1); c2 <- compute_F(r2); c3 <- compute_F(r3); c4 <- compute_F(r4)

  f_stat <- c(c1[1], c2[1], c3[1], c4[1], F5)
  p_val  <- c(c1[2], c2[2], c3[2], c4[2], pv5)
  labels <- c(
    sprintf("Projected F (r=%d)", r1),
    sprintf("Projected F (r=%d)", r2),
    sprintf("Projected F (r=%d)", r3),
    sprintf("Projected F (r=%d)", r4),
    "Wilks' Î› (chi-square approx)"
  )

  out <- data.frame(
    Test = labels,
    Statistic = round(f_stat, 6),
    P_value = signif(p_val, 6),
    stringsAsFactors = FALSE
  )

  if (verbose) {
    cat("\n=== æ£€éªŒç»“æœï¼ˆperplexity =", perplexity, ", k =", k, ") ===\n")
    print(out, row.names = FALSE)
  }
  invisible(list(table = out,
                 n = n, p = p, k = k,
                 r = c(r1 = r1, r2 = r2, r3 = r3, r4 = r4),
                 files = files_found))
}

# ====== ä½¿ç”¨ç¤ºä¾‹ ======
# å‡è®¾ä½ å·²å¯¼å‡ºäº†å¦‚ "perplexity_40_cluster_1_data.csv" ... cluster_5_data.csv
# ç›´æ¥è°ƒç”¨ï¼ˆæŠŠ P å’Œ k æ¢æˆä½ çš„å®é™…ï¼‰ï¼š
# res <- run_cluster_tests(perplexity = 40, k = 5, dir = ".")
# res$table
```

```{r}
# ====== æ‰¹å¤„ç†ï¼šå¾ªç¯æ‰€æœ‰ perplexityï¼Œæ•´ç†æˆæ€»è¡¨ ======

batch_run_tests <- function(perplexities, k, dir = ".", verbose_each = FALSE) {
  res_list <- list()

  for (P in perplexities) {
    if (verbose_each) cat("\n>>> æ­£åœ¨å¤„ç† perplexity =", P, "...\n")
    # è°ƒç”¨å‰é¢å®šä¹‰å¥½çš„å•æ¬¡æ£€éªŒå‡½æ•°
    res <- run_cluster_tests(perplexity = P,
                             k          = k,
                             dir        = dir,
                             verbose    = verbose_each)

    df <- res$table
    df$Perplexity <- P
    df$k <- k
    res_list[[as.character(P)]] <- df
  }

  all_res <- do.call(rbind, res_list)
  # è°ƒæ•´ä¸€ä¸‹åˆ—é¡ºåºçœ‹èµ·æ¥æ›´èˆ’æœ
  all_res <- all_res[, c("Perplexity", "k", "Test", "Statistic", "P_value")]
  rownames(all_res) <- NULL
  all_res
}

# ====== ä½¿ç”¨ç¤ºä¾‹ ======
# å‡è®¾ä½ ä¹‹å‰å¯¼å‡ºçš„æ–‡ä»¶åä¸ºï¼š
#   perplexity_10_cluster_1_data.csv ... cluster_5_data.csv
#   perplexity_20_cluster_1_data.csv ... cluster_5_data.csv
#   ...
# å¹¶ä¸” k = 5

perplexities <- c(10, 20, 30, 40)  # æ ¹æ®ä½ å®é™…å¯¼å‡ºçš„ perplexity æ”¹
k <- 3

all_results <- batch_run_tests(perplexities = perplexities,
                               k           = k,
                               dir         = ".",        # æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹
                               verbose_each = FALSE)     # TRUE æ—¶ä¼šé€ä¸ªæ‰“å°

# æŸ¥çœ‹æ€»è¡¨
print(all_results)

# å¯é€‰ï¼šå¯¼å‡ºæˆä¸€ä¸ªæ€»çš„ç»“æœè¡¨
write.csv(all_results,
          file = "all_perplexities_projectedF_Wilks_results.csv",
          row.names = FALSE)
```





```{r}
#  å…ˆt-SNE é™ç»´ + K-means èšç±»

library(Rtsne)
library(ggplot2)
library(RColorBrewer)

# 1. è¯»å…¥ & é¢„å¤„ç†
# 1. è¯»å…¥æ•°æ®
A0 <- read.csv("edgeR_CPM_Normalized_Counts_CD49f_CD133.csv", header = TRUE)

# 2. æ•°æ®é¢„å¤„ç†ï¼ˆå»æ‰ä¸å¿…è¦çš„åˆ— & NAï¼‰
data_clean <- na.omit(A0)
data_expr <- data_clean[, -1]  # å‡è®¾ç¬¬ä¸€åˆ—æ˜¯æ ·æœ¬å

# 3. é€‰å–å‰2000ä¸ªæ ·æœ¬ï¼ˆå¦‚æ ·æœ¬å°‘äº2000ï¼Œåˆ™å…¨é€‰ï¼‰
n <- min(2000, nrow(data_expr))
data_expr_subset <- data_expr[1:n, ]

# 4. è½¬ä¸ºçŸ©é˜µ
A <- as.matrix(data_expr_subset)

# 5. å»æ‰é‡å¤è¡Œï¼ˆt-SNE ä¸å…è®¸é‡å¤ï¼‰
A_unique <- unique(A)
dim(A_unique)


# 2. t-SNE é™ç»´
set.seed(42)
tsne_low <- Rtsne(A_unique, perplexity = 30)
tsne_data <- tsne_low$Y

# 3. K-means èšç±»ï¼ˆåœ¨äºŒç»´ç©ºé—´ä¸Šï¼‰
set.seed(42)
km_low <- kmeans(tsne_data, centers = 5)
clusters_low <- km_low$cluster

# 4. æ•´ç†æˆ data.frame
tsne_df_low <- data.frame(
  X = tsne_data[, 1],
  Y = tsne_data[, 2],
  Cluster = factor(clusters_low)
)

# 5. å¯è§†åŒ–
ggplot(tsne_df_low, aes(x = X, y = Y, color = Cluster)) +
  geom_point(size = 1.8, alpha = 0.8) +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  ggtitle("ğŸ…± t-SNE é™ç»´ + K-means èšç±»")

```
```{r}
library(Rtsne)
library(ggplot2)
library(RColorBrewer)
library(gridExtra)
perplexities <- c(10, 20, 30, 40)
k <- 5                # K-means èšç±»æ•°é‡
plots <- list()       # å­˜æ”¾ ggplot å¯¹è±¡
custom_colors <- brewer.pal(k, "Set1")

# -----------------------------
# 3. å¾ªç¯ç”Ÿæˆä¸åŒ perplexity çš„ t-SNE + K-means
# -----------------------------
for (p in perplexities){
  set.seed(42)
  tsne_res <- Rtsne(A_unique, perplexity = p, check_duplicates = FALSE, verbose = FALSE)
  tsne_data <- tsne_res$Y
  
  # K-means èšç±»ï¼ˆåœ¨äºŒç»´ t-SNE åæ ‡ä¸Šï¼‰
  set.seed(42) 
  km <- kmeans(tsne_data, centers = k)
  
  tsne_df <- data.frame(
    X = tsne_data[,1],
    Y = tsne_data[,2],
    Cluster = factor(km$cluster)
  )
  
  # ggplot ç»˜å›¾
  plots[[as.character(p)]] <- ggplot(tsne_df, aes(x=X, y=Y, color=Cluster)) +
    geom_point(size=1.8, alpha=0.8) +
    scale_color_manual(values = custom_colors) +
    ggtitle(paste("t-SNE, perplexity =", p)) +
    theme_minimal() +
    theme(axis.title.x = element_blank(), axis.title.y = element_blank())
}

# -----------------------------
# 4. 2x2 ç½‘æ ¼å±•ç¤º
# -----------------------------

grid.arrange(grobs = plots, nrow = 2, ncol = 2)
```



